<!DOCTYPE html>
<html>
<head>

    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <meta name="description" contents="">

    <title>Product Details layout (v1.1)</title>

    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/bootbox-dialoges.css">
    <link rel="stylesheet" href="/css/meter.css">
    <link rel="stylesheet" href="/css/spinner.css">
    <link rel="stylesheet" href="/css/alerts.css">
    <link rel="stylesheet" href="/css/anywhere3d.css">
    <link rel="stylesheet" href="/css/index.css">
    <!-- link rel="stylesheet" href="/style.css" -->

    <script src="/js/loadjs.min.js"></script>
    <script src="/js/jquery.min.js"></script>
    <script src="/js/jquery-ui.js"></script>
    <script src="/socketcluster.js"></script>
    <script src="/sc-codec-min-bin.js"></script>

</head>

<body>

<style>
    
    body {
        overflow:auto;
    }

    .snapshot-item {
        width:85px;
        height:85px;
        margin:4px;
        border:thin solid #ccc;
        background-size: contain;
        background-position:50% 50%;
        background-repeat:no-repeat;
    }

    .tab-pane {
        width:100%;
        min-height:250px;;
    }

    #product-title {
        outline:0;
        color:#999;
        border: none;
        background: none;
        box-shadow: none;
        font-size: 3rem;
        font-weight: bold;
        font-family: sans-serif;
        text-overflow:ellipsis;
    }

    #product-preview-pane {
        width:49%;
        height:600px;
        min-width:49%;
        max-width:100%;
        text-align:center;
        display:inline-block;
    /*  border:thin solid #ccc; */
    }

    #preview-container {
        max-width:100%;
        text-align:center;
        overflow:auto;
    }

    .swipe-element {
        position: relative;
    }

    img#product-preview {
        width:auto;
        margin:auto;
        min-height:350px;
        max-height:450px;
    }

    #product-info-pane {
        width:49%;
        height:600px;
        float:right;
        min-width:49%;
        max-width:100%;
        display:inline-block;
        border:thin solid #ccc;
    }

    #product-info {
        width:100%;
        margin:auto;
        height:600px;
        min-height:400px;
        max-height:600px;
    }

    @media all and ( max-width: 640px ) {

        #product-preview-pane {
            width:100%;
        }

        #product-info-pane {
            width:100%;
            float:unset;
            height:400px;
            min-height:400px;
            max-height:unset;

        }

        #product-info {
            height:100%;
        }

    }

    #description-tab {
        padding:30px;
    }

</style>

<section class="mbr-section" id="details-section">

<div class="container well">

    <div id="product-title-pane" style="margin-bottom:20px;">
        <input type="text" id="product-title" class="form-control text-center x-large product-title-field" placeholder="untitled product" readOnly>
    </div>

    <div id="product-preview-pane">

        <div id="preview-container swipe-element" style="max-width:100%;text-align:center;overflow:auto;">
            <img id="product-preview" src="/img/no-image-avaliable-200x200.png">
        </div>

        <script>
            (function(){
                const productPreview = $("img#product-preview").get(0);
                $(productPreview).on("load", function(){
                    if ( this.src.startsWith("blob:") ) {
                        window.URL.revokeObjectURL(this.src); // important!
                        debugMode && console.log("revoked", this.src);
                    }
                });
            })();
        </script>

        <div id="product-snapshots-pane" style="max-width:100%;display:inline-block;">
            <div id="product-snapshots-container" style="margin:20px 0px;overflow-y:hidden;max-width:100%;text-align:center;">
                <div id="product-snapshots" class="product-snapshots" style="display:inline-block;width:max-content;text-align:center;">
                    <li class="btn btn-default btn-white-outline snapshot-item product-snapshot-item"></li>
                    <li class="btn btn-default btn-white-outline snapshot-item product-snapshot-item"></li>
                    <li class="btn btn-default btn-white-outline snapshot-item product-snapshot-item"></li>
                    <li class="btn btn-default btn-white-outline snapshot-item product-snapshot-item"></li>
                    <li class="btn btn-default btn-white-outline snapshot-item product-snapshot-item"></li>
                    <li class="btn btn-default btn-white-outline snapshot-item product-snapshot-item"></li>
                    <li class="btn btn-default btn-white-outline snapshot-item product-snapshot-item"></li>
                    <li class="btn btn-default btn-white-outline snapshot-item product-snapshot-item"></li>
                    <li class="btn btn-default btn-white-outline snapshot-item product-snapshot-item"></li>
                    <li class="btn btn-default btn-white-outline snapshot-item product-snapshot-item"></li>
                    <li class="btn btn-default btn-white-outline snapshot-item product-snapshot-item"></li>
                    <li class="btn btn-default btn-white-outline snapshot-item product-snapshot-item"></li>
                    <li class="btn btn-default btn-white-outline snapshot-item product-snapshot-item"></li>
                    <li class="btn btn-default btn-white-outline snapshot-item product-snapshot-item"></li>
                    <li class="btn btn-default btn-white-outline snapshot-item product-snapshot-item"></li>
                </div>
            </div>
        </div>

    </div>

    <div id="product-info-pane">
        <div id="product-info"></div>
    </div>

    <div id="product-tabs-pane">

        <div style="width:100%;margin-bottom:20px;">
            <ul class="nav nav-tabs nav-pills" style="width:100%;overflow-x:auto;overflow-y:hidden;">

                <li class="active" role="presentation"><a href="#description-tab" data-toggle="pill" class="pills right-pill right-pill-description">Description</a></li>
                <li class role="presentation"><a href="#outfits-tab" data-toggle="pill" class="pills right-pill right-pill-outfits">Outfit</a></li>
                <li class role="presentation"><a href="#texture-tab" data-toggle="pill" class="pills right-pill right-pill-outfits">Texture</a></li>
                <li class role="presentation"><a href="#product-tab" data-toggle="pill" class="pills right-pill right-pill-product">Product</a></li>
                <!-- li class role="presentation"><a href="#edit-tab" data-toggle="pill" class="pills right-pill right-pill-edit">Edit</a></li -->

            </ul>
        </div>

        <div class="tab-content">

            <div id="description-tab" class="component-pane tab-pane fade in active"></div>
            <div id="outfits-tab" class="component-pane tab-pane fade"></div>
            <div id="texture-tab" class="component-pane tab-pane fade"></div>
            <div id="product-tab" class="component-pane tab-pane fade"></div>
            <!--div id="edit-tab" class="component-pane tab-pane fade"></div -->

        </div>

    </div>

    <div id="additional-tab-pane">

        <div style="width:100%;margin-bottom:20px;">
            <ul class="nav nav-tabs nav-pills" style="width:100%;overflow:hidden;">
                <li class="active" role="presentation" style="width:100%"><a href="#additional-options-tab" data-toggle="pill" class="pills right-pill right-pill-options">Additional options</a></li>
            </ul>
        </div>

        <div class="tab-content">
            <div id="additional-options-tab" class="component-pane tab-pane fade in active"></div>
        </div>

    </div>

</div>

</section>

<script>

    debugMode = true;

</script>

<script src="/js/rawinflate.js"></script>
<script src="/js/rawdeflate.js"></script>
<script src="/js/store2.js"></script>
<script src="/js/Objectid.js"></script>
<script src="/js/zangodb.min.js"></script>
<script src="/js/bootbox.min.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/DeviceDetector.js"></script>
<script src="/js/MathDecimalAdjustment.js"></script>
<script src="/js/watermark.js"></script>
<script src="/js/validator.js"></script>
<script src="/js/system.min.js"></script>
<script src="/js/signals.min.js"></script>
<script src="/js/validator.min.js"></script>
<script src="/js/alerts.js"></script>

<script>

    // Shim for requestAnimationFrame from Paul Irishpaul ir
    // http://www.paulirish.com/2011/requestanimationframe-for-smart-animating/
    window.requestAnimFrame = (function(){
        return  window.requestAnimationFrame   ||
            window.webkitRequestAnimationFrame ||
            window.mozRequestAnimationFrame    ||
            function( callback ){
            window.setTimeout(callback, 1000 / 60);
        };
    })();

//  [START pointereventsupport]

    var pointerDownName = 'pointerdown';
    var pointerUpName = 'pointerup';
    var pointerMoveName = 'pointermove';

    if (window.navigator.msPointerEnabled) {
        pointerDownName = 'MSPointerDown';
        pointerUpName = 'MSPointerUp';
        pointerMoveName = 'MSPointerMove';
    }

//  Simple way to check if some form of pointerevents is enabled or not
    window.PointerEventsSupport = false;
    if (window.PointerEvent || window.navigator.msPointerEnabled) {
        window.PointerEventsSupport = true;
    }

// [END pointereventsupport]

    function SwipeRevealItem(element) {

        // Gloabl state variables
        var STATE_DEFAULT = 1;
        var STATE_LEFT_SIDE = 2;
        var STATE_RIGHT_SIDE = 3;

        var swipeFrontElement = element.querySelector('.swipe-front');
        var rafPending = false;
        var initialTouchPos = null;
        var lastTouchPos = null;
        var currentXPosition = 0;
        var currentState = STATE_DEFAULT;
        var handleSize = 10;

        // Perform client width here as this can be expensive and doens't
        // change until window.onresize
        var itemWidth = swipeFrontElement.clientWidth;
        var slopValue = itemWidth * (1/4);

        // On resize, change the slop value
        this.resize = function() {
            itemWidth = swipeFrontElement.clientWidth;
            slopValue = itemWidth * (1/4);
        };

        /* // [START handle-start-gesture] */
        // Handle the start of gestures
        this.handleGestureStart = function(evt) {
            evt.preventDefault();

            if(evt.touches && evt.touches.length > 1) {
                return;
            }

            // Add the move and end listeners
            if (window.PointerEvent) {
                evt.target.setPointerCapture(evt.pointerId);
            } else {
                // Add Mouse Listeners
                document.addEventListener('mousemove', this.handleGestureMove, true);
                document.addEventListener('mouseup', this.handleGestureEnd, true);
            }

            initialTouchPos = getGesturePointFromEvent(evt);

            swipeFrontElement.style.transition = 'initial';
        }.bind(this);
        /* // [END handle-start-gesture] */

        // Handle move gestures
        //
        /* // [START handle-move] */
        this.handleGestureMove = function (evt) {
            evt.preventDefault();

            if(!initialTouchPos) {
                return;
            }

            lastTouchPos = getGesturePointFromEvent(evt);

            if(rafPending) {
                return;
            }

            rafPending = true;

            window.requestAnimFrame(onAnimFrame);
        }.bind(this);
        /* // [END handle-move] */

        /* // [START handle-end-gesture] */
        // Handle end gestures
        this.handleGestureEnd = function(evt) {
            evt.preventDefault();

            if(evt.touches && evt.touches.length > 0) {
                return;
            }

            rafPending = false;

            // Remove Event Listeners
            if (window.PointerEvent) {
                evt.target.releasePointerCapture(evt.pointerId);
            } else {
                // Remove Mouse Listeners
                document.removeEventListener('mousemove', this.handleGestureMove, true);
                document.removeEventListener('mouseup', this.handleGestureEnd, true);
            }

            updateSwipeRestPosition();

            initialTouchPos = null;
        }.bind(this);
        /* // [END handle-end-gesture] */

        function updateSwipeRestPosition() {
            var differenceInX = initialTouchPos.x - lastTouchPos.x;
            currentXPosition = currentXPosition - differenceInX;

            // Go to the default state and change
            var newState = STATE_DEFAULT;

            // Check if we need to change state to left or right based on slop value
            if(Math.abs(differenceInX) > slopValue) {
                if(currentState === STATE_DEFAULT) {
                    if(differenceInX > 0) {
                        newState = STATE_LEFT_SIDE;
                    } else {
                        newState = STATE_RIGHT_SIDE;
                    }
                } else {
                    if(currentState === STATE_LEFT_SIDE && differenceInX > 0) {
                        newState = STATE_DEFAULT;
                    } else if(currentState === STATE_RIGHT_SIDE && differenceInX < 0) {
                        newState = STATE_DEFAULT;
                    }
                }
            } else {
                newState = currentState;
            }

            changeState(newState);

            swipeFrontElement.style.transition = 'all 150ms ease-out';
        }

        function changeState(newState) {
            var transformStyle;
            switch(newState) {
                case STATE_DEFAULT:
                    currentXPosition = 0;
                    break;
                case STATE_LEFT_SIDE:
                    currentXPosition = -(itemWidth - handleSize);
                    break;
                case STATE_RIGHT_SIDE:
                    currentXPosition = itemWidth - handleSize;
                    break;
            }

            transformStyle = 'translateX('+currentXPosition+'px)';

            swipeFrontElement.style.msTransform = transformStyle;
            swipeFrontElement.style.MozTransform = transformStyle;
            swipeFrontElement.style.webkitTransform = transformStyle;
            swipeFrontElement.style.transform = transformStyle;

            currentState = newState;
        }

        function getGesturePointFromEvent(evt) {
            var point = {};

            if(evt.targetTouches) {
                point.x = evt.targetTouches[0].clientX;
                point.y = evt.targetTouches[0].clientY;
            } else {
                // Either Mouse event or Pointer Event
                point.x = evt.clientX;
                point.y = evt.clientY;
            }

            return point;
        }

        /* // [START on-anim-frame] */
        function onAnimFrame() {
            if(!rafPending) {
                return;
            }

            var differenceInX = initialTouchPos.x - lastTouchPos.x;

            var newXTransform = (currentXPosition - differenceInX)+'px';
            var transformStyle = 'translateX('+newXTransform+')';
            swipeFrontElement.style.webkitTransform = transformStyle;
            swipeFrontElement.style.MozTransform = transformStyle;
            swipeFrontElement.style.msTransform = transformStyle;
            swipeFrontElement.style.transform = transformStyle;

            rafPending = false;
        }
        /* // [END on-anim-frame] */

        /* // [START addlisteners] */
        // Check if pointer events are supported.
        if (window.PointerEvent) {
            // Add Pointer Event Listener
            swipeFrontElement.addEventListener('pointerdown', this.handleGestureStart, true);
            swipeFrontElement.addEventListener('pointermove', this.handleGestureMove, true);
            swipeFrontElement.addEventListener('pointerup', this.handleGestureEnd, true);
            swipeFrontElement.addEventListener('pointercancel', this.handleGestureEnd, true);
        } else {
            // Add Touch Listener
            swipeFrontElement.addEventListener('touchstart', this.handleGestureStart, true);
            swipeFrontElement.addEventListener('touchmove', this.handleGestureMove, true);
            swipeFrontElement.addEventListener('touchend', this.handleGestureEnd, true);
            swipeFrontElement.addEventListener('touchcancel', this.handleGestureEnd, true);

            // Add Mouse Listener
            swipeFrontElement.addEventListener('mousedown', this.handleGestureStart, true);
        }
        /* // [END addlisteners] */
    }

    var swipeRevealItems = [];

    window.onload = function () {

        var swipeRevealItemElements = document.querySelectorAll('.swipe-element');
        for(var i = 0; i < swipeRevealItemElements.length; i++) {
            swipeRevealItems.push(new SwipeRevealItem(swipeRevealItemElements[i]));
        }

        // We do this so :active pseudo classes are applied.
        window.onload = function() {
            if(/iP(hone|ad)/.test(window.navigator.userAgent)) {
                document.body.addEventListener('touchstart', function() {}, false);
            }
        };
    };

    window.onresize = function () {

        for (var i = 0; i < swipeRevealItems.length; i++) {
            swipeRevealItems[i].resize();
        }
    };

</script>

<script>

    const db = new zango.Db( "PRODUCTS", {
        products:   true,
        snapshots:  true,
    //  multiplex:  true,
    });

</script>

<script>

(function(){


    const title = document.getElementById("product-title");
    const preview = document.getElementById("product-preview");
    const snapshots = document.getElementById("product-snapshots");
    const descriptionTab = document.getElementById("description-tab");
    const previewContainer = document.getElementById("preview-container");

    if ( store("Product") ) {

        const product = store.remove("Product");
        debugMode && console.log(product);

        title.value = product.name;
        descriptionTab.innerText = product.description;

        caches.open("products").then(function(cache){
            var url = `//i.imgur.com/${product.preview}.jpg`
            cache.match(url).then(function(response){
                if (response) return response.blob();
                else return cache.add(url).then(function(){
                    return cach.match(url).then(function(response){
                        return response.blob();
                    });
                });
            }).then(function(blob){
                if (blob) preview.src = URL.createObjectURL(blob);
                else preview.src = url;
            });
        });

        caches.open("thumbnails").then(function(cache){

            $(snapshots).children().remove();

            product.snapshots.forEach(function(id){

                var background = `//i.imgur.com/${id}s.jpg`;
                cache.match(background).then(function(response){
                    if (response) return response.blob();
                    else return cache.add(background).then(function(){
                        return cach.match(background).then(function(response){
                            return response.blob();
                        });
                    });

                }).then(function(blob){

                    var element = document.createElement("li");
                    element.id = id;  // optional!
                    element.imageSrc = `//i.imgur.com/${id}.jpg`;
                    element.thumbnail = `//i.imgur.com/${id}s.jpg`;
                    element.classList.add("btn", "btn-default", "btn-white-outline", "snapshot-item", "product-snapshot-item");
                //  element.style.cssText = `background-size:contain;background-position:50% 50%;background-repeat:no-repeat;background-image:url(${background});`;

                    if (blob) element.style.cssText = `background-image:url(${URL.createObjectURL(blob)})`;
                    else element.style.cssText = `background-image:url(${background})`;

                    $(element).on("click", function(){
                        caches.open("products").then(function(cache){
                            cache.match(element.imageSrc).then(function(response){
                                if (response) return response.blob();
                                else return cache.add(element.imageSrc).then(function(){
                                    return cach.match(element.imageSrc).then(function(response){
                                        return response.blob();
                                    });
                                });
                            }).then(function(blob){
                                if (blob) preview.src = URL.createObjectURL(blob);
                                else preview.src = element.imageSrc;
                            });
                        });
                    });

                    return element;

                }).then(function(snapshot){
                    $(snapshots).append(snapshot);

                //  Revoke.
                    var objectURL = snapshot.style["background-image"]
                                 .replace("url(", "").replace(")", "");
                    debugMode && console.log("revoked", objectURL);

                    if ( objectURL.startsWith("blob:") ) {
                        URL.revokeObjectUrl( objectURL );
                    }

                });

            });

        });

    }

})();

</script>


</body>
</html>
