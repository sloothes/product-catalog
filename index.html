<!DOCTYPE html>
<html>
<head>

    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <meta name="description" contents="">

    <title>My products (v1.6)</title>

    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/bootbox-dialoges.css">
    <link rel="stylesheet" href="/css/meter.css">
    <link rel="stylesheet" href="/css/spinner.css">
    <link rel="stylesheet" href="/css/alerts.css">
    <link rel="stylesheet" href="/css/anywhere3d.css">
    <link rel="stylesheet" href="/css/index.css">
    <!-- link rel="stylesheet" href="/style.css" -->
    <link rel="stylesheet" href="/photoswipe/dist/photoswipe.css">
    <link rel="stylesheet" href="/photoswipe/dist/default-skin/default-skin.css">

    <script>debugMode = true;</script>
    <script src="/js/loadjs.min.js"></script>
    <script src="/socketcluster.js"></script>
    <script src="/sc-codec-min-bin.js"></script>
    <script src="/photoswipe/dist/photoswipe.js"></script>
    <script src="/photoswipe/dist/photoswipe-ui-default.js"></script>

</head>

<body>

<style>

    body {
        overflow:auto;
    }

    .well { 
        background:none; 
    }

    .well.product-card { 
    /*  vertical-align:middle !important;  */
        color: #fff;
        display:inline-block; 
        height:48%; 
        width:22.8rem;
    }

    .card-field-price {
        font-size:3rem;
        font-weight:bold;
        font-family:sans-serif;
        text-align:center;
    }

    .card-field-title {
        color:#ccc;
        max-width:100%;
        font-size:2rem;
        font-weight:normal;
        font-family:sans-serif;
        text-overflow:ellipsis;
        text-align:center;
    }

    #catalog-section {
        overflow:auto;
        background-color:#000;
    }

    #products-display {
        border:none;
        height:700px;
        min-width:320px;
        min-height:438px;
        max-height:705px;
        text-align:center;
        overflow:auto;
    }

    @media all and ( max-width: 640px ) {

        .well.product-card { 
            display:inline-block; 
            height:65%; 
            width:100%;
        }

    }

    /*  photoswipe  */

    .viewer {
        width:750px;
        height:750px;
        max-width:90%;
        max-height:90%;
        background:#ffffff33;
    }

</style>

<section class="mbr-section" id="catalog-section">

<div id="product-catalog-panel" class="tab-content" style="width:100%;">

    <div id="catalog-items-panel" class="well" style="width:100%;margin:0;">

        <h4 style="color:#fff;">My products:
            <div id="counter-right-top" class="pull-right small items-counter" style="margin-top:4px;color:#ddd;">
                <span class="from">zero</span>
                to <span class="upto">zero</span>
                of <span class="count">none</span>
            </div>
        </h4>

        <div id="product-catalog-pager" class="pager">
            <div style="margin:10px auto 10px auto;height:35px;max-width:350px;">
                <li class="btn btn-primary get-prev-btn pull-left">&#9668;</li>
                <div class="pager-buttons-holder" style="display:inline;">
                    <a class="btn btn-default page-btn">1</a>
                    <a class="btn btn-default page-btn">2</a>
                    <a class="btn btn-default page-btn">3</a>
                    <a class="btn btn-default page-btn">4</a>
                </div>
                <li class="btn btn-primary get-next-btn pull-right">&#9658;</li>
            </div>

            <div id="products-display" class="well"></div>

            <div style="margin:10px auto 10px auto;height:35px;max-width:350px;">
                <li class="btn btn-primary btn-white-outline first-page-btn pull-left" style="margin-right:5px;">First</li>
                <li class="btn btn-primary btn-white-outline get-prev-group-btn pull-left">&#9668;&#9668;</li>
                <div id="counter" class="small items-counter" style="width:fit-content;display:inline;height:35px;margin-top:4px;color:#ddd;">
                    <span class="from">zero</span> to <span class="upto">zero</span> of <span class="count">none</span>
                </div>
                <li class="btn btn-primary btn-white-outline last-page-btn pull-right" style="margin-left:5px;">Last</li>
                <li class="btn btn-primary btn-white-outline get-next-group-btn pull-right">&#9658;&#9658;</li>
            </div>
        </div>

    </div>

</div>

    <!-- PHOTOSWIPE -->

<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="pswp__bg"></div>
    <div class="pswp__scroll-wrap">
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>
        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">
            <div class="pswp__top-bar">
                <!--  Controls are self-explanatory. Order can be changed. -->
                <div class="pswp__counter"></div>
                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
                <button class="pswp__button pswp__button--share" title="Share"></button>
                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
                <!-- Preloader demo https://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>
            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button>
            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>
        </div>
    </div>
</div>

</section>


<script src="/js/rawinflate.js"></script>
<script src="/js/rawdeflate.js"></script>
<script src="/js/store2.js"></script>
<script src="/js/Objectid.js"></script>
<script src="/js/zangodb.min.js"></script>
<script src="/js/jquery.min.js"></script>
<script src="/js/jquery-ui.js"></script>
<script src="/js/bootbox.min.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/DeviceDetector.js"></script>
<script src="/js/MathDecimalAdjustment.js"></script>
<script src="/js/watermark.js"></script>
<script src="/js/validator.js"></script>
<script src="/js/system.min.js"></script>
<script src="/js/signals.min.js"></script>
<script src="/js/validator.min.js"></script>
<script src="/js/alerts.js"></script>

<script>

//  const VERSION = 1;
    const NAME = "PRODUCTS";
    var db = new zango.Db( NAME, {
        products:   true,
        snapshots:  true,
        multiplex:  true,
    });

    db.open(function(err, database){
        if (err) console.error(err);
    }).then( function(){
        debugMode && console.log(`${db.name} (v${db.version}) opened.`);
    }).catch(function(err){
        console.error(err);
    });

</script>

<script>

(function(){

    const collection = db.collection("products");
    debugMode && console.log({"collection":collection});

//  Pager.

    const pager  = document.getElementById("product-catalog-pager");
    const displayObjects = document.getElementById("products-display");
    const catalogItemsPanel = document.getElementById("catalog-items-panel");
    const productCatalogPanel = document.getElementById("product-catalog-panel");
    const productCatalogPager = document.getElementById("product-catalog-pager");

    var pagebuttons = $(pager).find(".page-btn");
    var pageslength = $(pager).find(".page-btn").length;

    const firstPageBtn = $(pager).find(".first-page-btn").get(0);
    const lastPageBtn  = $(pager).find(".last-page-btn").get(0);
    const prevPageBtn  = $(pager).find(".get-prev-btn").get(0);
    const nextPageBtn  = $(pager).find(".get-next-btn").get(0);
    const prevGroupBtn = $(pager).find(".get-prev-group-btn").get(0);
    const nextGroupBtn = $(pager).find(".get-next-group-btn").get(0);

    const pageSelector = "#product-catalog-pager .page-btn";

    const counter = $(catalogItemsPanel).find("#counter").get(0);
    const counterRT = $(catalogItemsPanel).find("#counter-right-top").get(0);

    var timeout;
    var interval;
    var selectors;
    var delay = 200;

    var limit = 12;
    var currency = "$"; // important!

    var max = 0;
    var skip = 0;
    var lastpage = 0;
    var currentpage = 0;
    var currentindex = 0;

//  Signals.
    var Signal = signals.Signal;

//  too slow!
//  For performance we count items only when we ask last page 
//  or we change droplist selectors. Not need to count on backward.

    function count(){
        var k = skip;
        return collection.find(selectors)
        .skip(skip).forEach( 
            function(doc){ ++k; }, 
            function(err){ if (err) throw err; }
        ).catch(function(err){
            console.error(err);
        }).then(function(){
            return k;
        });
    }

    function reset(){

        max = 0;
        skip = 0;
        lastpage = 0;
        currentpage = 0;
        currentindex = 0;

    }

    function init(){

    //  Page buttons numbering.
        pagebuttons.each(function(i){
            pagebuttons[i].skip = limit * i;
            $(pagebuttons[i]).text( i + 1 );
        });

    //  Current button setup.
        pagebuttons.removeClass("btn-primary");
        var currentButton = pagebuttons.get(0);
        $(currentButton).addClass("btn-primary");

    //  Clear listed objects.
        $(displayObjects).children().remove();

    }

    function get_items(){

        collection.find(selectors).skip(skip)
        .limit(limit).toArray(function(err){
            if (err) throw err;
        }).then(function(docs){

            $(displayObjects).children().remove();
            debugMode && console.log({"docs":docs});

            $(catalogItemsPanel).find(".from").text(skip + 1); 
            $(catalogItemsPanel).find(".upto").text(skip + docs.length);
            $(catalogItemsPanel).find(".count").text(skip + docs.length);

            caches.open("thumbnails").then(function(cache){

                docs.forEach(function(doc){

                    var card = document.createElement("li");
                    card.id = doc._id; card.data = doc; // optional!
                    card.classList.add("well", "product-card");
                    card.style.cssText = "vertical-align:middle!important;";

                    var img = new Image();
                    img.classList.add("thumbnail");
                    img.style.cssText = "width:auto;height:50%;margin:0 auto 10px auto;";
                    var url = `https://i.imgur.com/${doc.preview}s.jpg`;

                    cache.match(url).then(function(response){
                        if (response) return response.blob();
                        else return cache.add(url).then(function(){
                            return cach.match(url).then(function(response){
                                return response.blob();
                            });
                        });
                    }).then(function(blob){
                        if (blob) $(img).on("load", function(){
                            URL.revokeObjectURL(img.src);
                        }).attr({src:URL.createObjectURL(blob)});
                        else img.src = url; // `https://i.imgur.com/${doc.preview}s.jpg`;
                    });

                    var price = document.createElement("div");
                    price.classList.add("card-field-price");
                    if ( doc.price == null ) {
                        price.innerText = price.title = "no value";
                    } else { 
                        price.innerText = price.title = currency + doc.price.toFixed(2);
                    }

                    var title = document.createElement("input");
                    title.classList.add("form-control", "card-field-title");
                    title.type = "text"; title.readonly = true; title.value = title.title = doc.name;
                    title.style.cssText = "background:none;border:none;background:none;box-shadow:none;";

                    var details = document.createElement("span");
                    details.innerText = "Details";
                    details.product_UUID = doc.uuid; // important!
                    details.classList.add("btn", "btn-info", "btn-white-outline");
                    details.style.cssText = "width:50%;background-color:#42bcf9;";

                    $(details).on("click", function(){

                    //  TODO: Open a sale page with details of the product. 
                        console.log({"product_UUID":details.product_UUID});






                        store("Product", doc);  // store product data to localStorage.
                        window.location.pathname = "/products-catalog/details.html";

                    });

                    $(card).append(img, price, title, details);

                    $(displayObjects).append( card );

                });

            }).catch(function(err){
                console.error(err);
            });

            return docs;

        }).then(function(docs){

        //  photoswipe.js

            var pswp = $(".pswp").get(0);
            var psui = PhotoSwipeUI_Default;

            var items = []; // build items array.

            docs.forEach(function(json, index){
                items.push({
                    html: `<div class="middle" data-index="${index}">`
                    + `<iframe class="thumbnail viewer" `
                    + `src="details.html"></iframe></div>`
                });
            });

            var options = {
                index: 0, // start at selected index slide.
            //  read for options: https://photoswipe.com/documentation/options.html
            };

            var gallery = new PhotoSwipe( pswp, psui, items, options );

            gallery.init();

        //  currentIndex = gallery.itemHolders[1].index;
            debugMode && console.log({"gallery": gallery});

        }).catch(function(err){
            console.error(err);
        });

    }

    function pagerClicked(){

    //  Get last page.
        lastpage = parseInt( max / limit );

    //  Get current page.
        currentpage = parseInt( skip / limit );

    //  Get current index.
        currentindex = parseInt( currentpage % pageslength );

    //  Page buttons numbering.
        var num = parseInt( currentpage / pageslength ) * pageslength;

        pagebuttons.each(function(i){
            var page = num + i;
            pagebuttons[i].skip = limit * page; // important!
            $(pagebuttons[i]).text( page + 1 ); // important!
        });

    //  Current button setup.
        pagebuttons.removeClass("btn-primary");
        var currentButton = pagebuttons.get( currentindex );
        $(currentButton).addClass("btn-primary");

    //  Display info.

        if ( max == 0 )
            $(counter).find("#from").text("-"); 
        else if ( skip == max )
            $(counter).find("#from").text(skip);
        else
            $(counter).find("#from").text(skip + 1);

        if ( max == 0 )
            $(counter).find("#upto").text("-");
        else if ( skip + limit > max )
            $(counter).find("#upto").text( max );
        else
            $(counter).find("#upto").text(skip + limit);

        $(counter).find("#count").text(max);

        debugMode && console.log({"max":max, "skip":skip, "index": currentindex});

        if ( max && skip < max ) {

            clearTimeout(interval);
            interval = setTimeout( get_items, delay );

        }

    }

    get_items();

})();

</script>

</body>
</html>

<script>

/*
    function productCardTemplateDemo(){

        var card = document.createElement("li");
        card.classList.add("well", "product-card");

        var img = new Image();
        img.classList.add("thumbnail");
        img.src = "/img/no-image-avaliable-200x200.png";
        img.style.cssText = "width:auto;height:50%;margin:0 auto 10px auto;";

        var price = document.createElement("div");
        price.classList.add("card-field-price");
        price.innerText = "0.00" + "&nbsp;&thorn;";
        price.style.cssText = "font-size:3rem;font-weight:bold;font-family:sans-serif;";

        var title = document.createElement("div");
        title.classList.add("card-field-title");
        title.innerText = "Sed ac metus fermentum nisi lacinia sodales.";
        title.style.cssText = "font-size:2rem;font-weight:normal;font-family:sans-serif;max-height:6rem;overflow:hidden;text-overflow:ellipsis;";

        var button = document.createElement("span");
        button.innerText = "Details";
        button.classList.add("btn", "btn-info", "btn-white-outline");
        button.style.cssText = "width:50%;background-color:#42bcf9;";

        $(card).append(img, price, title, button);

        return card;
    }

    <li class="well product-card">
        <img src="/img/no-image-avaliable-200x200.png" class="thumbnail" style="width:auto;height:50%;margin:0 auto 10px auto;">
        <div class="card-field-price" style="font-size:3rem;font-weight:bold;font-family:sans-serif;">22.99&nbsp;&thorn;</div>
        <div class="card-title-field" style="font-size:2rem;font-weight:normal;font-family:sans-serif;max-height:6rem;overflow:hidden;">Product title row<br>second title row</div>
        <span class="btn btn-info btn-white-outline" style="width:50%;background-color:#42bcf9;">Details</span>
    </li>
*/

</script>

<!--
    <li class="well product-card" style="vertical-align:middle !important;">
        <img src="/img/no-image-avaliable-200x200.png" class="thumbnail" style="width:auto;height:50%;margin:0 auto 10px auto;">
        <div class="card-field-price">43.99</div>
        <input type="text" class="form-control card-field-title" value="Sed ac metus fermentum nisi lacinia sodales" readOnly 
        style="background:none;border:none;background:none;box-shadow:none;max-width:100%;">
        <span class="btn btn-info btn-white-outline" style="width:50%;background-color:#42bcf9;">Details</a>
    </li>

    <li class="well product-card" style="vertical-align:middle !important;">
        <img src="/img/no-image-avaliable-200x200.png" class="thumbnail" style="width:auto;height:50%;margin:0 auto 10px auto;">
        <div class="card-field-price">2.99</div>
        <input type="text" class="form-control card-field-title" value="Sed ac metus fermentum nisi lacinia sodales" readOnly 
        style="background:none;border:none;background:none;box-shadow:none;max-width:100%;">
        <span class="btn btn-info btn-white-outline" style="width:50%;background-color:#42bcf9;">Details</a>
    </li>

    <li class="well product-card" style="vertical-align:middle !important;">
        <img src="/img/no-image-avaliable-200x200.png" class="thumbnail" style="width:auto;height:50%;margin:0 auto 10px auto;">
        <div class="card-field-price">32.99</div>
        <input type="text" class="form-control card-field-title" value="Sed ac metus fermentum nisi lacinia sodales" readOnly 
        style="background:none;border:none;background:none;box-shadow:none;max-width:100%;">
        <span class="btn btn-info btn-white-outline" style="width:50%;background-color:#42bcf9;">Details</a>
    </li>

    <li class="well product-card" style="vertical-align:middle !important;">
        <img src="/img/no-image-avaliable-200x200.png" class="thumbnail" style="width:auto;height:50%;margin:0 auto 10px auto;">
        <div class="card-field-price">122.99</div>
        <input type="text" class="form-control card-field-title" value="Sed ac metus fermentum nisi lacinia sodales" readOnly 
        style="background:none;border:none;background:none;box-shadow:none;max-width:100%;">
        <span class="btn btn-info btn-white-outline" style="width:50%;background-color:#42bcf9;">Details</a>
    </li>
-->

